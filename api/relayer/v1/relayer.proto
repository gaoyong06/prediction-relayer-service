syntax = "proto3";

package relayer.v1;

option go_package = "prediction-relayer-service/api/relayer/v1;v1";

import "google/api/annotations.proto";

// TransactionType 交易类型枚举
enum TransactionType {
  TRANSACTION_TYPE_UNSPECIFIED = 0;
  WALLET_DEPLOYMENT = 1;  // 钱包部署
  TOKEN_APPROVAL = 2;     // 代币授权
  CTF_SPLIT = 3;          // CTF 拆分
  CTF_MERGE = 4;          // CTF 合并
  CTF_REDEEM = 5;         // CTF 赎回
  CLOB_ORDER = 6;         // CLOB 订单执行
  CUSTOM = 7;             // 自定义交易
}

// WalletType 钱包类型枚举
enum WalletType {
  WALLET_TYPE_UNSPECIFIED = 0;
  SAFE = 1;    // Gnosis Safe Wallet
  PROXY = 2;   // Custom Proxy Wallet
}

service Relayer {
  // SubmitTransaction 提交单笔交易
  rpc SubmitTransaction (SubmitTransactionRequest) returns (SubmitTransactionReply) {
    option (google.api.http) = {
      post: "/prediction-relayer/v1/submit"
      body: "*"
    };
  }

  // SubmitBatchTransaction 提交批量交易
  rpc SubmitBatchTransaction (SubmitBatchTransactionRequest) returns (SubmitBatchTransactionReply) {
    option (google.api.http) = {
      post: "/prediction-relayer/v1/submit/batch"
      body: "*"
    };
  }

  // DeployWallet 部署钱包（Safe Wallet）
  rpc DeployWallet (DeployWalletRequest) returns (DeployWalletReply) {
    option (google.api.http) = {
      post: "/prediction-relayer/v1/wallet/deploy"
      body: "*"
    };
  }

  // GetTransactionStatus 查询交易状态
  rpc GetTransactionStatus (GetTransactionStatusRequest) returns (GetTransactionStatusReply) {
    option (google.api.http) = {
      get: "/prediction-relayer/v1/status/{task_id}"
    };
  }

  // GetBuilderFeeStats 查询 Builder 费用统计
  rpc GetBuilderFeeStats (GetBuilderFeeStatsRequest) returns (GetBuilderFeeStatsReply) {
    option (google.api.http) = {
      get: "/prediction-relayer/v1/builder/fees"
    };
  }

  // GetOperatorBalance 查询 Operator 余额
  rpc GetOperatorBalance (GetOperatorBalanceRequest) returns (GetOperatorBalanceReply) {
    option (google.api.http) = {
      get: "/prediction-relayer/v1/operator/balance"
    };
  }

  // SubmitMatch 提交订单匹配结果（用于 CLOB 订单执行）
  rpc SubmitMatch (SubmitMatchRequest) returns (SubmitMatchReply) {
    option (google.api.http) = {
      post: "/prediction-relayer/v1/match"
      body: "*"
    };
  }

  // GetTransactionHashByOrderID 根据订单 ID 获取交易哈希
  rpc GetTransactionHashByOrderID (GetTransactionHashByOrderIDRequest) returns (GetTransactionHashByOrderIDReply) {
    option (google.api.http) = {
      get: "/prediction-relayer/v1/orders/{order_id}/transaction"
    };
  }
}

// SubmitTransactionRequest 提交交易请求
message SubmitTransactionRequest {
  string to = 1;                    // 目标合约地址
  string data = 2;                  // 编码后的函数调用数据（hex）
  string signature = 3;             // 用户签名（消息签名，不是交易签名）
  string forwarder = 4;             // 转发器合约地址（可选）
  int64 gas_limit = 5;              // 预估 Gas Limit（可选）
  TransactionType transaction_type = 6; // 交易类型
  string value = 7;                 // 交易金额（hex，通常为 "0x0"）
}

// SubmitTransactionReply 提交交易响应
message SubmitTransactionReply {
  string task_id = 1;               // 唯一任务 ID
  bool success = 2;
  string message = 3;
}

// SubmitBatchTransactionRequest 批量提交交易请求
message SubmitBatchTransactionRequest {
  repeated TransactionRequest transactions = 1; // 交易数组
  string builder_api_key = 2;       // Builder API Key（用于费用追踪）
}

// TransactionRequest 单笔交易请求（用于批量）
message TransactionRequest {
  string to = 1;
  string data = 2;
  string signature = 3;
  string forwarder = 4;
  int64 gas_limit = 5;
  TransactionType transaction_type = 6;
  string value = 7;
}

// SubmitBatchTransactionReply 批量提交交易响应
message SubmitBatchTransactionReply {
  repeated string task_ids = 1;      // 任务 ID 数组
  bool success = 2;
  string message = 3;
}

// DeployWalletRequest 部署钱包请求
message DeployWalletRequest {
  WalletType wallet_type = 1;       // 钱包类型
  repeated string owners = 2;        // 所有者地址（仅 Safe Wallet 需要）
}

// DeployWalletReply 部署钱包响应
message DeployWalletReply {
  string wallet_address = 1;        // 部署的钱包地址
  string task_id = 2;                // 任务 ID
  bool success = 3;
  string message = 4;
}

// GetTransactionStatusRequest 查询交易状态请求
message GetTransactionStatusRequest {
  string task_id = 1;
}

// TransactionStatus 交易状态
message TransactionStatus {
  string task_id = 1;
  string tx_hash = 2;
  string status = 3;                // PENDING, MINED, FAILED, REPLACED
  string gas_price = 4;             // Gas 价格（字符串，支持大整数）
  int64 block_number = 5;
  int64 gas_used = 6;
  int64 created_at = 7;
  int64 updated_at = 8;
}

// GetTransactionStatusReply 查询交易状态响应
message GetTransactionStatusReply {
  TransactionStatus status = 1;
}

// GetBuilderFeeStatsRequest 查询 Builder 费用统计请求
message GetBuilderFeeStatsRequest {
  string api_key = 1;                // Builder API Key
  int64 start_time = 2;              // 开始时间（Unix 时间戳）
  int64 end_time = 3;                // 结束时间（Unix 时间戳）
}

// FeeStatsByType 按类型统计的费用
message FeeStatsByType {
  int64 count = 1;                   // 交易数量
  string gas_used = 2;               // Gas 消耗（字符串）
  string cost = 3;                   // 总成本（MATIC，字符串）
}

// GetBuilderFeeStatsReply 查询 Builder 费用统计响应
message GetBuilderFeeStatsReply {
  int64 total_transactions = 1;      // 总交易数
  string total_gas_used = 2;         // 总 Gas 消耗（字符串）
  string total_cost = 3;             // 总成本（MATIC，字符串）
  map<string, FeeStatsByType> by_type = 4; // 按类型统计（key 为交易类型字符串）
}

// GetOperatorBalanceRequest 查询 Operator 余额请求
message GetOperatorBalanceRequest {
  string operator_address = 1;       // Operator 地址（可选，默认使用主 Operator）
}

// GetOperatorBalanceReply 查询 Operator 余额响应
message GetOperatorBalanceReply {
  string operator_address = 1;
  string balance = 2;                // 余额（wei，字符串）
  string balance_matic = 3;         // 余额（MATIC，字符串）
}

// Order 订单信息（用于匹配）
message Order {
  string id = 1;                     // 订单 ID
  string maker = 2;                  // Maker 地址
  string signer = 3;                 // 签名者地址
  string taker = 4;                  // Taker 地址
  string token_id = 5;               // Token ID
  string maker_amount = 6;           // Maker 数量（BigInt as string）
  string taker_amount = 7;           // Taker 数量（BigInt as string）
  string side = 8;                   // BUY or SELL
  string price = 9;                  // 价格（BigInt as string）
  string size = 10;                  // 数量（BigInt as string）
  string remaining = 11;              // 剩余数量（BigInt as string）
  int64 expiration = 12;             // 过期时间戳
  string salt = 13;                  // 随机盐值
  string nonce = 14;                 // Nonce
  string fee_rate_bps = 15;          // 手续费率（基点）
  string signature = 16;             // EIP-712 签名
  int32 signature_type = 17;         // 签名类型：0=EOA, 1=POLY_PROXY, 2=GNOSIS_SAFE
  string funder = 18;                // 资金地址
  string order_type = 19;            // 订单类型：GTC, FOK, IOC
  string owner = 20;                 // 订单所有者（API key）
}

// SubmitMatchRequest 提交匹配请求
message SubmitMatchRequest {
  Order maker_order = 1;             // Maker 订单
  Order taker_order = 2;             // Taker 订单
  string price = 3;                  // 匹配价格（BigInt as string）
  string size = 4;                   // 匹配数量（BigInt as string）
  string token_id = 5;               // Token ID
  int64 timestamp = 6;               // 匹配时间戳
}

// SubmitMatchReply 提交匹配响应
message SubmitMatchReply {
  string task_id = 1;                // 任务 ID
  bool success = 2;
  string message = 3;
}

// GetTransactionHashByOrderIDRequest 根据订单 ID 获取交易哈希请求
message GetTransactionHashByOrderIDRequest {
  string order_id = 1;                // 订单 ID
}

// GetTransactionHashByOrderIDReply 根据订单 ID 获取交易哈希响应
message GetTransactionHashByOrderIDReply {
  string transaction_hash = 1;        // 交易哈希
  bool success = 2;
  string message = 3;
}
